# 今日学んだこと

## 取り組んだ課題一覧
- ハッカソン（4h）
    - infra(1h30m)
         - アーキテクチャ図を修正(RDSのパラメータ設計や、計画メンテナンス／障害時の対応方針も反映)
    - frontend(2h30m)
         - メンテナンスページの画面遷移図を作成(Figma)
         - メンテナンスページを実装(HTML & CSS)

![AWSアーキテクチャ図（最終版）](/img/20250502-aws-architecturediagram.png)

![さぶちゃん日記 メンテナンスページ](/img/20250502-saburo-maintenance.png)

## わかったこと
- メンテナンスページ
    - メンテナンス時はCloudFrontからS3へ向けてメンテナンスページ（静的ファイル）を配信
    - ALB経由ではなく、CloudFrontのカスタムエラーページ機能を利用して、表示を制御する
    - アップロードの手間を考慮し、終了予定時刻は表示しなくても良いケースもある
         - 計画的メンテナンスでは表示
         - 突発障害時は表示不要なケースもある
    - /src直下にHTMLを配置し、CloudFrontのオリジンパスをメンテナン用に切り替えをするなど動的に対応可能
    - 終了予定時刻あり／なし」の両方に対応できるようにしたいが、Lambdaで時間判定して出し分ける必要がある（将来的には、**Lambdaで時間判定し表示を切り替える**実装も視野に）
- メンテナンス用途の違いと対応方針
    - 突発障害対応：**Route53のフェイルオーバールーティング**
    - CloudFrontもRoute53で名前解決される
    - フェイルオーバーでSorryページへ誘導（自動切換え）
    - 計画的メンテナンス：CloudFront + S3 経由で表示
         - オリジン切り替え or カスタムエラーページを活用
- **Fargate異常検知**
    - アプリケーションがECS on Fargate上で稼働している構成において、サービスが異常停止した際に、ユーザーにその旨を通知するためのメンテナンスページを自動で表示させることが目的
    - これを実現するために、ALBのヘルスチェック失敗をトリガーとして異常検知し、CloudFront側でうまく制御して静的メンテナンスページ（S3）を返す構成を設ける必要がある
    - CloudFrontがリダイレクトするのではなく、CloudFrontがALBからの5xxレスポンスを受けて、S3のメンテナンスページを代替レスポンスとして返す
    - [通常時]ユーザー → CloudFront → ALB→ （ターゲット: ECS on Fargate）→ ECS on Fargate ← 正常なレスポンス（200など）
    - [異常時（例：Fargateが落ちた）]ユーザー → CloudFront → ALB→ （ターゲットが **unhealthy**）→ 5xx（例：502 Bad Gateway）を検知し、CloudFrontに返す ← CloudFrontがカスタムエラーページ（例：S3のHTML）を返す
    - Error Pages の設定で「レスポンスコード 502 のときに /maintenance/index.html を返す」という “  **レスポンスの置き換え（override）**”を行う

![Route53のフェイルオーバールーティング](/img/20250502.png)

- ALBとの連携
    - ALB配下にFargateコンテナを配置
    - ALBの固定レスポンス機能でもメンテページは可能
    - ALBのヘルスチェックが通らなかった場合（失敗）、CloudFrontを/maintenanceへリダイレクト
    - トップページでステータスコード200以外を検知してSorryページへ飛ばす構成も可能
- RDSとCloudFormation
    - RDSのパラメータ設計を反映したテンプレートをYAMLで管理（スタックパラメータを定義）
    - 全インフラ構成を1スタックに統合する
    - dependsOn属性でリソース間の依存関係を明示し、コンテナ起動順序を把握できる
- インフラ設計
    - dependsOn属性を使って依存関係を明示（コンテナが起動する順番を理解する必要がある）
    - Datadogはinitコンテナ（sidecar）で起動時にdata-agentへリバースプロキシ的な処理を行うイメージ → データ送信を制御

## 感じたこと
- メンテナンスページの目的と使い分けを明確にすることの重要性を実感した
    - 単なる表示ではなく、「**誰に、いつ、どういう意図で見せるのか**」を意識すべき
- アーキテクチャ設計時の**誤認**に注意
   - ALB → メンテナンスページが配信されると思っていたが、CloudFront → S3(メンテナンスページの静的ファイル)を配信する流れが正しい
   - **構成要素ごとの役割を正しく理解することが、信頼性のある設計につながる**

## 次やること
- infra
    - 本番環境を構築する
- 講師案件
    - 講義の構成を考える
- 資格学習
    - AWS SAA

## 学習時間
- Today: 4h
- week : 14h 40m
- Monthly : 5h
- Total: 57h 35m