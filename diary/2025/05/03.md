# 今日学んだこと

## 取り組んだ課題一覧
- ハッカソン（2h）
    - ミーティング(2h)
         - 認証機能に関する結合テスト
         - DB Migration
    - infra(4h)
         - 本番環境を構築する
         - FastAPIアプリのデプロイに失敗し原因を調査 → 疎通確認完了し、解決
         - 手順書の作成（途中）
※ミーティングは学習時間に含めません     

## わかったこと
- 誤ったイメージURIを指定したままデプロイすると、**サービスは正常に起動していてもアプリは機能しない**
- タスク定義のリビジョン更新と、サービスへの適用を忘れないよう明示的なチェックが必要
- 通信経路（例: CloudFront → ALB → ECSコンテナ）やDNSの紐付けの重要性を再認識した
    - ALBを再作成したら、Route53にて新たにAレコードを作成しなおす必要がある → 手動で更新し直さないと通信が切れる
    - 今回、ALBのDNS名（saburo-api-alb-848826909.ap-northeast-1.elb.amazonaws.com）が変わったのに、Aレコードが古いままだったため接続できなかった
    - Route 53でのAレコード（ALIAS）設定の重要性を再確認した
- AWS ECS on Fargate + ALB + Route 53 + ECRを中心とした構成の正確な理解が進んだ
    - すべてのリソースの作成には問題がなかった
         - ECSクラスター、サービス、タスク定義、ECRリポジトリ、ALB、Route53など、**個々のリソースは正しく作成されていた**
         - しかし、**ECRイメージを更新しても、タスク定義とサービスに反映しなければデプロイは反映されない**
         -  **インフラ構成では「リソースを作ること」よりも「リソース間の接続と更新の整合性確認」がより重要** 

## デプロイ失敗の原因
- ECRのイメージURIの不整合
   - 正しいURI: 881490128743.dkr.ecr.ap-northeast-1.amazonaws.com/saburo-fastapi:latest
   - テスト用のサンプルイメージ（FastAPI公式）から更新されていなかった   - 
- タスク定義のリビジョン反映漏れ
   - タスク定義を新しく作成しても、サービス側で新しいリビジョンを指定しない限り旧バージョンのまま動作する
- ALB作成に伴うRoute53再設定漏れ
   - api.saburo.xyz のAレコードが、新しいALB（saburo-api-alb-848826909.ap-northeast-1.elb.amazonaws.com）に更新されていなかった
   - ALBを新規作成した際に、Route 53のAレコードが未更新だったため、ドメインアクセスが失敗した

## 通信・コンテナ起動の流れ（中間発表の説明案）

![AWSアーキテクチャ図](/img/20250503-aws-architecturediagram.png)

- **ユーザー側の通信の流れ**
   - まず、ユーザーがWebブラウザで「さぶちゃん日記」にアクセスすると、リクエストはCloudFrontに送られます
   - CloudFrontでは、通常時はS3バケット上にホスティングされたNext.jsの静的ファイルが配信されますが、障害時やメンテナンス中には別のS3バケットにあるメンテナンスページを返すよう切り替え可能です
   - Next.jsのフロントエンドからバックエンドのAPIを呼び出すときは、サブドメイン api.saburo.xyz を経由して、ALB（Application Load Balancer）に到達します
   - ALBはターゲットグループを通じて、ECS on Fargate上にデプロイされたFastAPIアプリケーションコンテナへルーティングします
   - APIの応答内容はALB→CloudFront経由でユーザーに返され、全体の通信はHTTPSで暗号化されています
- **開発者側の操作・CI/CDの流れ**
   - 開発者はGitHub上でコードを管理しており、GitHub Actionsを通じてFastAPIアプリやDB Migration用のコンテナイメージをECRにビルド＆プッシュしています
   - このとき、開発者アカウントにはMFA（多要素認証）を設定しており、セキュリティを担保しています
   - Terraformで各種インフラリソースはコード化（IaC）されており、RDSのパラメータグループ設定もCloudFormationテンプレートにより自動化しています
- **コンテナの起動の流れ（Fargate）**
   - コンテナ起動の流れについては、Fargateのタスク定義に複数のコンテナが含まれています
   - まず、Datadog用のinitコンテナ（init-datadog）が起動し、監視用エージェントの準備を行います
   - その後、datadog-agentコンテナがバックグラウンドで常駐し、ログやメトリクスをCloudWatchやGmail通知と連携しています
   - アプリケーション本体の FastAPIコンテナ は、その後 dependsOn 属性で順序制御されて起動します
   - 起動後は、ALB経由でリクエストを受け付け、MySQLと連携してレスポンスを返します
   - また、DB Migration用のRunTask は、EventBridge Scheduler + Lambda経由で定期的または任意のタイミングで起動されます
   - これによりAlembicベースのマイグレーションが自動で実行され、手動の運用負荷を削減しています
- **RDS（MySQL）構成と認証情報の取り扱い**
   - バックエンドのデータベースには、Amazon RDS for MySQL を採用しています
   - 本番環境では、マルチAZ構成を使用しており、東京リージョン内の2つのAZにプライマリとスタンバイを配置することで、高可用性と自動フェイルオーバーに対応しています
   - これにより、仮に片方のAZで障害が発生しても、もう一方のAZに自動的に切り替わるため、サービス継続性が担保される設計となっています
   - また、データベースの接続情報やパスワードは、Secrets Managerで一元管理しています
   - FastAPIコンテナなどのアプリケーションからは、環境変数を通じて動的に取得しており、ハードコード（一般的にパスワードや接続情報を**プログラムの中に直接書いてしまうこと**）を避けて、
   セキュリティを確保した構成にしています
   - Secrets Managerの値は、タスク定義でIAMロールを付与することで、最小権限の原則に則ってアクセス制御を行っています

## 感じたこと
- インフラ構成の変更があるたびに、DNS設定やサービス構成を見直す必要がある
    - 今回のようにALBを新しく作り直した場合、見た目上では構成が完成していても、Route 53のAレコードが古いままだと、ユーザーからのアクセスは失敗してしまう
    - 「**構成要素を正しく作った（完成）＝システムが動く**」と思い込まず、**それぞれのリソースが正しく連携し、疎通できているかを実際に確認すること**の重要性を学んだ
    - 特に本番環境では、こうした小さな見落としが大きな障害につながる可能性があるため、構成変更時はチェックリストをもとに検証を徹底すべきと感じた
- タスク定義とECRイメージの管理は慎重に行う必要があると痛感した
   - ECRに最新のイメージをPushしても、それを参照するタスク定義が更新されていなければ古いイメージでコンテナが起動してしまう
   - さらに、タスク定義を更新しても、サービス側が新しいリビジョンを使うよう明示的に設定しない限り、以前のバージョンが使われ続ける
   - この一連の手順を忘れてしまうと、「デプロイしたのに内容が反映されない」「なぜか古い挙動のまま」といった事態に直結する
   - 今後は「ECR → タスク定義 → サービス」の連携を意識し、更新確認を徹底する必要があると感じた

## 次やること
- infra
    - 本番環境を構築
    - 手順書を作成
- 資格学習
    - AWS SAA

## 学習時間
- Today: 4h
- week : 18h 40m
- Monthly : 9h
- Total: 61h 35m